# JAVA ——多线程



## 1、线程安全

**定义：在拥有共享数据的多条线程并行执行的程序中，线程安全的代码会通过同步机制保证各个线程都可以正常且正确的执行，不会出现数据污染等意外情况。**

### 简介：

多个线程访问同一个对象时，如果不用考虑这些线程在运行时环境下的调度和交替执行，也不需要进行额外的同步，或者在调用方进行任何其他操作，调用这个对象的行为都可以获得正确的结果，那么这个对象就是线程安全的。

或者说：一个类或者程序所提供的接口对于线程来说是[原子操作](https://baike.baidu.com/item/原子操作)或者多个线程之间的切换不会导致该接口的执行结果存在二义性，也就是说我们不用考虑同步的问题。

<u>**即一段程序在多线程并发执行时，其每一个线程的操作都是原子操作的，则该程序是线程安全的，否则线程不安全。**</u>

<u>线程安全问题大多是由[全局变量](https://baike.baidu.com/item/全局变量)及[静态变量](https://baike.baidu.com/item/静态变量)引起的，局部变量逃逸也可能导致线程安全问题。</u

==**若每个线程中对全局变量、静态变量只有读操作，而无写操作，一般来说，这个全局变量是线程安全的；若有多个线程同时执行写操作，一般都需要考虑[线程同步](https://baike.baidu.com/item/线程同步)，否则的话就可能影响线程安全。**==

###  线程安全与可重入

如果一个函数能够安全地同时被多个线程调用而得到正确的结果，那么，我们说这个函数是线程安全的。所谓“安全”，一切可能导致结果不正确的因素都是不安全的调用。 

线程安全，是针对多线程而言的。与可重入联系起来，一般来说：[可重入函数](https://baike.baidu.com/item/可重入函数/4521100)是线程安全的（也有例外），但线程安全的不一定是可重入的。不可重入函数，函数调用结果不具有可再现性，可以通过互斥锁等机制使之能安全地同时被多个线程调用，那么，这个不可重入函数就是转换成了线程安全。 

可重入（Reentrant）函数可以由多于一个任务并发使用，而不必担心数据错误。相反地，不可重入( Non - Reentrant)函数不能由超过一个任务所共享，除非能确保函数的互斥（或者使用信号量，或者在代码的关键部分禁用中断）。可重入函数可以在任意时刻被中断，稍后再继续运行，不会丢失数据。可重入函数要么使用本地变量，要么在使用全局变量时保护自己的数据。 



## 2、可重入函数

**定义：可重入函数主要用于多任务环境中，一个可重入的函数简单来说就是可以被中断的函数，也就是说，可以在这个函数执行的任何时刻中断它，转入OS调度下去执行另外一段代码，而返回控制时不会出现什么错误；而不可重入的函数由于使用了一些系统资源，比如[全局变量](https://baike.baidu.com/item/全局变量/4725296)区，[中断向量表](https://baike.baidu.com/item/中断向量表/4947137)等，所以它如果被中断的话，可能会出现问题，这类函数是不能运行在多任务环境下的**

### 简介：

可重入函数也可以这样理解，重入即表示重复进入，首先它意味着这个函数可以被中断，其次意味着它除了使用自己栈上的变量以外不依赖于任何环境（包括static），这样的函数就是==**purecode（[纯代码](https://baike.baidu.com/item/纯代码)）**==可重入，可以允许有多个该函数的副本在运行，由于它们使用的是分离的栈，所以不会互相干扰。如果确实需要访问[全局变量](https://baike.baidu.com/item/全局变量)（包括static），一定要注意实施互斥手段。可重入函数在并行运行环境中非常重要，但是一般要为访问全局变量付出一些性能代价。

### 注意事项：

编写可重入函数时，若使用[全局变量](https://baike.baidu.com/item/全局变量)，则应通过关中断、[信号量](https://baike.baidu.com/item/信号量)（即P、V操作）等手段对其加以保护。

若对所使用的全局变量不加以保护，则此函数就不具有可重入性，即当多个线程调用此函数时，很有可能使有关全局变量变为不可知状态。 

### 与线程安全的关系 

可重入与[线程安全](https://baike.baidu.com/item/线程安全)两个概念都关系到函数处理资源的方式。但是，他们有重大区别：

- 可重入概念会影响函数的外部接口，而线程安全只关心函数的实现。

- - 大多数情况下，要将不可重入函数改为可重入的，需要修改函数接口，使得所有的数据都通过函数的调用者提供。
  - 要将非线程安全的函数改为线程安全的，则只需要修改函数的实现部分。一般通过加入[同步机制](https://baike.baidu.com/item/同步机制)以保护共享的资源，使之不会被几个线程同时访问。

- 操作系统背景与CPU调度策略：

- - 可重入是在单线程操作系统背景下，重入的函数或者子程序，按照后进先出的线性序依次执行完毕。
  - 多线程执行的函数或子程序，各个线程的执行时机是由操作系统调度，不可预期的，但是该函数的每个执行线程都会不时的获得CPU的时间片，不断向前推进执行进度。

- 可重入函数未必是线程安全的；线程安全函数未必是可重入的。  <u>-----此处有矛盾，若该函数使用外部资源未加保护，那是否还是可重入？</u>

- - 例如，一个函数打开某个文件并读入数据。这个函数是可重入的，因为它的多个实例同时执行不会造成冲突；但它不是线程安全的，因为在它读入文件时可能有别的线程正在修改该文件，为了线程安全必须对文件加“同步锁”。
  - 另一个例子，函数在它的函数体内部访问共享资源使用了加锁、解锁操作，所以它是线程安全的，但是却不可重入。因为若该函数一个实例运行到已经执行加锁但未执行解锁时被停下来，系统又启动该函数的另外一个实例，则新的实例在加锁处将转入等待。如果该函数是一个中断处理服务，在中断处理时又发生新的中断将导致资源死锁。fprintf函数就是线程安全但不可重入。 



### 3、可重入代码

**定义：可重入代码(Reentry code)也叫[纯代码](https://baike.baidu.com/item/纯代码/5669644)(Pure code)是一种允许多个进程同时访问的代码。为了使各进程所执行的代码完全相同，故不允许任何进程对其进行修改。[程序](https://baike.baidu.com/item/程序/71525)在运行过程中可以被打断，并由开始处再次执行，并且在合理的范围内（多次重入，而不造成[堆栈溢出](https://baike.baidu.com/item/堆栈溢出/1231765)等其他问题），程序可以在被打断处继续执行，且执行结果不受影响。**



#### 与线程安全的关系

可重入与[线程安全](https://baike.baidu.com/item/线程安全)两个概念都关系到函数处理资源的方式。但是，他们有一定的区别。可重入概念会影响函数的外部接口，而线程安全只关心函数的实现。

- 大多数情况下，要将不可重入函数改为可重入的，需要修改函数接口，使得所有的数据都通过函数的调用者提供。
- 要将非线程安全的函数改为线程安全的，则只需要修改函数的实现部分。一般通过加入同步机制以保护共享的资源，使之不会被几个线程同时访问。

[线程安全](https://baike.baidu.com/item/线程安全)与可重入性是两个不同性质的概念。可重入是在单线程操作系统背景下，重入的函数或者子程序，按照后进先出的线性序依次执行完毕。多线程执行的函数或子程序，各个线程的执行时机是由操作系统调度，不可预期的，但是该函数的每个执行线程都会不时的获得CPU的时间片，不断向前推进执行进度。



## 4、可重入函数与线程安全的区别与联系

**可重入函数**

- 重入：重复调用，函数被不同的流调用，有可能会出现第一次调用还没返回时就再次进入该函数开始下一次调用。
- 可重入：当程序被多个线程反复执行，产生的结果正确。
- 不可重入：当程序被多个线程反复调用，产生的结果出错。
- 可重入函数：一个函数只访问自己的局部变量或参数。
- 不可重入函数：当函数访问一个全局的变量或者参数时，有可能因为重入而造成混乱。

***\*线程安全\****

- 线性安全：一个函数当且仅当被多个并发线程反复调用时，它会一直产生正确的结果，被称为线程安全。

***\*可重入特点\****

- 由于可重入函数多次调用不会出错，因此可重入函数不用担心数据会被破坏。可重入函数任何时候都可以被中断，一段时间后又可以运行，而相应的数据不会丢失。可重入函数只使用局部变量，即保存在CPU寄存器或者堆栈中；或者如果使用全局变量时，则要对全局变量予以保护。

**不可重入特点**

​        如果一个函数符合以下条件之一的，则是不可重入的：

- 调用了malloc/free函数，因为malloc函数是用全局链表来管理堆的。
- 调用了标准I/O库函数，标准I/O库的很多实现都以不可重入的方式使用全局数据结构。
- 可重入体内使用了静态的数据结构。

**可重入函数和线程安全**
        可重入函数与线程安全并不相同，一般来说，可重入的函数一定是线程安全的，但反过来不一定成立，关系可有下图解释。
    所有函数

***可重入函数与线程安全的区别与联系\***

- 线程安全是在多个线程情况下引发的，而可重入函数可以在只有一个线程的情况下来说。
- 线程安全不一定是可重入的，而可重入函数则一定是线程安全的。
- 如果一个函数中有全局变量，那么这个函数既不是线程安全也不是可重入的。
- 如果将对临界资源的访问加上锁，则这个函数是线程安全的，但如果这个重入函数若锁还未释放则会产生死锁，因此是不可重入的。
- 线程安全函数能够使不同的线程访问同一块地址空间，而可重入函数要求不同的执行流对数据的操作互不影响使结果是相同的。

------------------------------------------------
